---
import { LANGUAGES, type Language } from '../i18n/index';

interface Props {
  currentLang: Language;
}

const { currentLang } = Astro.props;
---

<div class="relative" id="language-switcher">
  <button
    type="button"
    class="flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700"
    aria-label="Sprache wÃ¤hlen"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <span class="text-lg">{LANGUAGES[currentLang].flag}</span>
    <span class="hidden sm:inline">{LANGUAGES[currentLang].nativeName}</span>
    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div
    class="absolute right-0 top-full z-50 mt-1 hidden min-w-[160px] rounded-lg border border-gray-200 bg-white py-1 shadow-lg dark:border-gray-700 dark:bg-gray-800"
    id="language-menu"
    role="menu"
  >
    {Object.entries(LANGUAGES).map(([code, { nativeName, flag }]) => (
      <a
        href={`/${code}/`}
        class={`flex items-center gap-3 px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 ${
          code === currentLang ? 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400' : ''
        }`}
        role="menuitem"
      >
        <span class="text-lg">{flag}</span>
        <span>{nativeName}</span>
        {code === currentLang && (
          <svg class="ml-auto h-4 w-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        )}
      </a>
    ))}
  </div>
</div>

<script>
  const switcher = document.getElementById('language-switcher');
  const button = switcher?.querySelector('button');
  const menu = document.getElementById('language-menu');

  button?.addEventListener('click', () => {
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    button.setAttribute('aria-expanded', String(!isExpanded));
    menu?.classList.toggle('hidden');
  });

  // Close on click outside
  document.addEventListener('click', (e) => {
    if (!switcher?.contains(e.target as Node)) {
      button?.setAttribute('aria-expanded', 'false');
      menu?.classList.add('hidden');
    }
  });

  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      button?.setAttribute('aria-expanded', 'false');
      menu?.classList.add('hidden');
    }
  });
</script>
