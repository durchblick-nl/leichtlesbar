---

---

<div class="space-y-6">
  <!-- Text Input -->
  <div>
    <label for="text-input" class="mb-2 block text-lg font-medium dark:text-white">
      Geben Sie Ihren Text ein:
    </label>
    <textarea
      id="text-input"
      rows="8"
      class="w-full rounded-lg border border-gray-300 bg-white p-4 text-base focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:placeholder-gray-400"
      placeholder="Fügen Sie hier Ihren Text ein, um die Lesbarkeit zu analysieren..."
    ></textarea>
    <div class="mt-2 flex flex-wrap items-center justify-between gap-2 text-sm text-gray-500 dark:text-gray-400">
      <div class="flex items-center gap-2">
        <span id="word-hint">Für zuverlässige Ergebnisse mindestens 30 Wörter.</span>
        <span id="live-word-count" class="font-medium">0 Wörter</span>
      </div>
      <!-- Example texts dropdown -->
      <div class="relative">
        <button
          id="example-toggle"
          type="button"
          class="flex items-center gap-1 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"
          aria-expanded="false"
          aria-haspopup="true"
        >
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Beispieltexte
          <svg class="h-4 w-4 transition-transform" id="example-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div id="example-menu" class="absolute right-0 z-10 mt-1 hidden w-64 rounded-lg border border-gray-200 bg-white shadow-lg dark:border-gray-700 dark:bg-gray-800">
          <div class="py-1">
            <button class="example-btn w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-level="leicht">
              <span class="font-medium text-green-600 dark:text-green-400">Leicht</span>
              <span class="text-gray-500 dark:text-gray-400"> – Kinderbuch</span>
            </button>
            <button class="example-btn w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-level="mittel">
              <span class="font-medium text-yellow-600 dark:text-yellow-400">Mittel</span>
              <span class="text-gray-500 dark:text-gray-400"> – Nachrichtenartikel</span>
            </button>
            <button class="example-btn w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-level="schwer">
              <span class="font-medium text-red-600 dark:text-red-400">Schwer</span>
              <span class="text-gray-500 dark:text-gray-400"> – Wissenschaft</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Container -->
  <div id="results" class="hidden space-y-6">

    <!-- Main Score with Gauge - Deutsche Amstad-Formel -->
    <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
      <h2 class="mb-2 text-center text-xl font-bold dark:text-white">Flesch-Index (Amstad)</h2>
      <p class="mb-4 text-center text-sm text-gray-500 dark:text-gray-400">Deutsche Formel nach Toni Amstad (1978)</p>

      <!-- Gauge with gradient -->
      <div class="relative mx-auto mb-8 h-36 w-64">
        <svg viewBox="0 0 200 120" class="w-full" role="img" aria-label="Lesbarkeits-Anzeige">
          <title>Lesbarkeits-Gauge</title>
          <!-- Gradient definitions -->
          <defs>
            <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#dc2626" />
              <stop offset="25%" stop-color="#ea580c" />
              <stop offset="50%" stop-color="#eab308" />
              <stop offset="75%" stop-color="#84cc16" />
              <stop offset="100%" stop-color="#22c55e" />
            </linearGradient>
            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
              <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <!-- Background arc -->
          <path
            d="M 20 90 A 80 80 0 0 1 180 90"
            fill="none"
            stroke="#e5e7eb"
            stroke-width="14"
            stroke-linecap="round"
            class="dark:stroke-gray-700"
          />

          <!-- Colored gradient arc -->
          <path
            d="M 20 90 A 80 80 0 0 1 180 90"
            fill="none"
            stroke="url(#gaugeGradient)"
            stroke-width="12"
            stroke-linecap="round"
          />

          <!-- Tick marks -->
          <g class="text-gray-400 dark:text-gray-500" fill="currentColor" font-size="8">
            <text x="15" y="98" text-anchor="middle">0</text>
            <text x="100" y="8" text-anchor="middle">50</text>
            <text x="185" y="98" text-anchor="middle">100</text>
          </g>

          <!-- Needle -->
          <g id="gauge-needle-group" style="transform-origin: 100px 90px;" class="transition-transform duration-700 ease-out">
            <line x1="100" y1="90" x2="100" y2="20" stroke="#1f2937" stroke-width="3" stroke-linecap="round" class="dark:stroke-white" filter="url(#glow)" />
            <circle cx="100" cy="90" r="8" fill="#1f2937" class="dark:fill-white" />
            <circle cx="100" cy="90" r="4" fill="#3b82f6" />
          </g>

          <!-- Score display inside SVG -->
          <text id="score-display-svg" x="100" y="115" text-anchor="middle" font-size="24" font-weight="bold" class="fill-gray-900 dark:fill-white">--</text>
        </svg>
      </div>

      <p id="interpretation" class="text-center text-lg text-gray-600 dark:text-gray-300">--</p>
    </div>

    <!-- Additional Metrics - 2x2 Grid -->
    <div class="grid gap-4 sm:grid-cols-2">
      <!-- Flesch-Kincaid Grade Level -->
      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-700 dark:bg-gray-800">
        <h3 class="mb-2 text-sm font-medium text-gray-500 dark:text-gray-400">Flesch-Kincaid Grade Level</h3>
        <div id="kincaid-score" class="text-2xl font-bold dark:text-white">--</div>
        <p id="kincaid-interpretation" class="text-sm text-gray-600 dark:text-gray-300">--</p>
      </div>

      <!-- Wiener Sachtextformel -->
      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-700 dark:bg-gray-800">
        <h3 class="mb-2 text-sm font-medium text-gray-500 dark:text-gray-400">Wiener Sachtextformel</h3>
        <div id="wiener-score" class="text-2xl font-bold dark:text-white">--</div>
        <p id="wiener-interpretation" class="text-sm text-gray-600 dark:text-gray-300">--</p>
      </div>

      <!-- Gunning-Fog -->
      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-700 dark:bg-gray-800">
        <h3 class="mb-2 text-sm font-medium text-gray-500 dark:text-gray-400">Gunning-Fog-Index</h3>
        <div id="fog-score" class="text-2xl font-bold dark:text-white">--</div>
        <p id="fog-interpretation" class="text-sm text-gray-600 dark:text-gray-300">--</p>
      </div>

      <!-- LIX -->
      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-700 dark:bg-gray-800">
        <h3 class="mb-2 text-sm font-medium text-gray-500 dark:text-gray-400">LIX Lesbarkeitsindex</h3>
        <div id="lix-score" class="text-2xl font-bold dark:text-white">--</div>
        <p id="lix-interpretation" class="text-sm text-gray-600 dark:text-gray-300">--</p>
      </div>
    </div>

    <!-- Statistics Grid -->
    <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
      <h3 class="mb-4 font-medium dark:text-white">Textstatistiken</h3>
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <div class="rounded-lg bg-gray-50 p-3 dark:bg-gray-700">
          <div class="text-xs text-gray-500 dark:text-gray-400">Wörter</div>
          <div id="word-count" class="text-xl font-semibold dark:text-white">--</div>
        </div>
        <div class="rounded-lg bg-gray-50 p-3 dark:bg-gray-700">
          <div class="text-xs text-gray-500 dark:text-gray-400">Sätze</div>
          <div id="sentence-count" class="text-xl font-semibold dark:text-white">--</div>
        </div>
        <div class="rounded-lg bg-gray-50 p-3 dark:bg-gray-700">
          <div class="text-xs text-gray-500 dark:text-gray-400">Silben</div>
          <div id="syllable-count" class="text-xl font-semibold dark:text-white">--</div>
        </div>
        <div class="rounded-lg bg-gray-50 p-3 dark:bg-gray-700">
          <div class="text-xs text-gray-500 dark:text-gray-400">Wörter pro Satz</div>
          <div id="words-per-sentence" class="text-xl font-semibold dark:text-white">--</div>
        </div>
        <div class="rounded-lg bg-gray-50 p-3 dark:bg-gray-700">
          <div class="text-xs text-gray-500 dark:text-gray-400">Silben pro Wort</div>
          <div id="syllables-per-word" class="text-xl font-semibold dark:text-white">--</div>
        </div>
        <div class="rounded-lg bg-gray-50 p-3 dark:bg-gray-700">
          <div class="text-xs text-gray-500 dark:text-gray-400">Verschiedene Wörter</div>
          <div id="unique-words" class="text-xl font-semibold dark:text-white">--</div>
        </div>
      </div>
    </div>

    <!-- Sentence Analysis -->
    <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
      <h3 class="mb-4 font-medium dark:text-white">Satzanalyse</h3>
      <p class="mb-4 text-sm text-gray-500 dark:text-gray-400">
        Sätze eingefärbt nach Lesbarkeit:
        <span class="inline-block rounded bg-green-100 px-2 py-0.5 text-green-800 dark:bg-green-900 dark:text-green-200">leicht</span>
        <span class="inline-block rounded bg-yellow-100 px-2 py-0.5 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">mittel</span>
        <span class="inline-block rounded bg-red-100 px-2 py-0.5 text-red-800 dark:bg-red-900 dark:text-red-200">schwer</span>
      </p>
      <div id="sentence-analysis" class="leading-relaxed dark:text-gray-200">
        <!-- Sentences will be inserted here -->
      </div>
    </div>

    <!-- Warning -->
    <div id="warning" class="hidden rounded-lg border border-yellow-200 bg-yellow-50 p-4 text-yellow-800 dark:border-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200">
      Achtung: Für zuverlässigere Ergebnisse empfehlen wir einen längeren Text (mindestens 30 Wörter).
    </div>
  </div>
</div>

<script>
  import { analyzeText, type Difficulty, type FullAnalysisResult } from '../utils/flesch';

  const textInput = document.getElementById('text-input') as HTMLTextAreaElement;
  const results = document.getElementById('results');
  const warning = document.getElementById('warning');
  const liveWordCount = document.getElementById('live-word-count');
  const exampleToggle = document.getElementById('example-toggle');
  const exampleMenu = document.getElementById('example-menu');
  const exampleChevron = document.getElementById('example-chevron');
  const exampleButtons = document.querySelectorAll('.example-btn');

  // Example texts for different difficulty levels
  const exampleTexts: Record<string, string> = {
    leicht: `Der Hund läuft im Park. Er ist braun und klein. Die Sonne scheint hell. Kinder spielen auf der Wiese. Sie lachen und rennen. Ein Ball fliegt durch die Luft. Der Hund jagt dem Ball nach. Er fängt ihn mit dem Maul. Alle freuen sich. Es ist ein schöner Tag. Die Vögel singen in den Bäumen. Der Wind weht sanft. Die Blumen blühen bunt. Es riecht nach Frühling. Die Familie macht ein Picknick.`,
    mittel: `Die Schweizer Wirtschaft zeigt sich auch im dritten Quartal robust. Der Arbeitsmarkt entwickelt sich weiterhin positiv, wobei die Arbeitslosenquote auf einem historisch niedrigen Niveau verharrt. Experten rechnen jedoch mit einer Abschwächung des Wachstums in den kommenden Monaten. Die Nationalbank beobachtet die Inflationsentwicklung genau und behält sich weitere geldpolitische Massnahmen vor. Unternehmen investieren verstärkt in nachhaltige Technologien.`,
    schwer: `Die epistemologische Grundlegung der Kognitionswissenschaften manifestiert sich in der interdisziplinären Verschränkung neurobiologischer, psychologischer und philosophischer Erkenntnistheorien. Die Implementierung artifizieller neuronaler Netzwerke zur Approximation kognitiver Prozesse impliziert fundamentale Fragestellungen hinsichtlich der Replizierbarkeit emergenter Bewusstseinsphänomene. Die methodologische Triangulation qualitativer und quantitativer Forschungsparadigmen ermöglicht eine multidimensionale Perspektive auf die Komplexität mentaler Repräsentationen.`
  };

  const difficultyColors: Record<Difficulty, { text: string; bg: string }> = {
    'sehr-schwer': { text: 'text-red-800 dark:text-red-200', bg: 'bg-red-100 dark:bg-red-900/50' },
    'schwer': { text: 'text-orange-800 dark:text-orange-200', bg: 'bg-orange-100 dark:bg-orange-900/50' },
    'mittelschwer': { text: 'text-yellow-800 dark:text-yellow-200', bg: 'bg-yellow-100 dark:bg-yellow-900/50' },
    'mittel': { text: 'text-lime-800 dark:text-lime-200', bg: 'bg-lime-100 dark:bg-lime-900/50' },
    'leicht': { text: 'text-green-800 dark:text-green-200', bg: 'bg-green-100 dark:bg-green-900/50' },
    'sehr-leicht': { text: 'text-emerald-800 dark:text-emerald-200', bg: 'bg-emerald-100 dark:bg-emerald-900/50' },
    'extrem-leicht': { text: 'text-teal-800 dark:text-teal-200', bg: 'bg-teal-100 dark:bg-teal-900/50' },
  };

  const scoreTextColors: Record<Difficulty, string> = {
    'sehr-schwer': 'text-red-600 dark:text-red-400',
    'schwer': 'text-orange-600 dark:text-orange-400',
    'mittelschwer': 'text-yellow-600 dark:text-yellow-400',
    'mittel': 'text-lime-600 dark:text-lime-400',
    'leicht': 'text-green-600 dark:text-green-400',
    'sehr-leicht': 'text-emerald-600 dark:text-emerald-400',
    'extrem-leicht': 'text-teal-600 dark:text-teal-400',
  };

  function updateGaugeNeedle(score: number) {
    const needleGroup = document.getElementById('gauge-needle-group');
    if (!needleGroup) return;

    // Score von 0-100 auf Winkel -90 bis 90 Grad mappen
    const clampedScore = Math.max(0, Math.min(100, score));
    const angle = -90 + (clampedScore / 100) * 180;
    needleGroup.style.transform = `rotate(${angle}deg)`;
  }

  function countWords(text: string): number {
    return text.trim().split(/\s+/).filter(w => w.length > 0).length;
  }

  function updateAnalysis() {
    const text = textInput.value.trim();
    const wordCount = countWords(text);

    // Live word count update
    if (liveWordCount) {
      liveWordCount.textContent = `${wordCount} Wörter`;
    }

    if (text.length === 0 || wordCount < 3) {
      results?.classList.add('hidden');
      return;
    }

    const analysis = analyzeText(text);

    // Show results
    results?.classList.remove('hidden');

    // Update Flesch-Amstad score and gauge (deutsche Formel)
    const scoreDisplaySvg = document.getElementById('score-display-svg');
    if (scoreDisplaySvg) {
      scoreDisplaySvg.textContent = analysis.flesch.scoreAmstad.toString();
    }
    updateGaugeNeedle(Math.max(0, analysis.flesch.scoreAmstad));

    const interpretation = document.getElementById('interpretation');
    if (interpretation) {
      interpretation.textContent = analysis.flesch.interpretationAmstad;
    }

    // Update Flesch-Kincaid
    document.getElementById('kincaid-score')!.textContent = analysis.fleschKincaid.gradeLevel.toString();
    document.getElementById('kincaid-interpretation')!.textContent = analysis.fleschKincaid.interpretation;

    // Update additional metrics
    document.getElementById('wiener-score')!.textContent = analysis.wiener.score.toString();
    document.getElementById('wiener-interpretation')!.textContent = analysis.wiener.interpretation;

    document.getElementById('fog-score')!.textContent = analysis.gunningFog.score.toString();
    document.getElementById('fog-interpretation')!.textContent = analysis.gunningFog.interpretation;

    document.getElementById('lix-score')!.textContent = analysis.lix.score.toString();
    document.getElementById('lix-interpretation')!.textContent = analysis.lix.interpretation;

    // Update statistics
    document.getElementById('word-count')!.textContent = analysis.flesch.wordCount.toString();
    document.getElementById('sentence-count')!.textContent = analysis.flesch.sentenceCount.toString();
    document.getElementById('syllable-count')!.textContent = analysis.flesch.syllableCount.toString();
    document.getElementById('words-per-sentence')!.textContent = analysis.flesch.avgWordsPerSentence.toString();
    document.getElementById('syllables-per-word')!.textContent = analysis.flesch.avgSyllablesPerWord.toString();
    document.getElementById('unique-words')!.textContent = analysis.flesch.uniqueWords.toString();

    // Update sentence analysis with colored sentences
    const sentenceContainer = document.getElementById('sentence-analysis');
    if (sentenceContainer) {
      sentenceContainer.innerHTML = analysis.sentences.map(sentence => {
        const colors = difficultyColors[sentence.difficulty];
        return `<span class="inline rounded px-1 py-0.5 ${colors.bg} ${colors.text}" title="Score: ${sentence.score}, Wörter: ${sentence.wordCount}">${sentence.text}</span>`;
      }).join(' ');
    }

    // Warning for short texts
    if (analysis.flesch.wordCount < 30) {
      warning?.classList.remove('hidden');
    } else {
      warning?.classList.add('hidden');
    }
  }

  // Debounce function for real-time analysis
  let debounceTimer: ReturnType<typeof setTimeout>;
  function debounce(func: () => void, delay: number) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(func, delay);
  }

  // Real-time analysis on input
  textInput?.addEventListener('input', () => {
    debounce(updateAnalysis, 300);
  });

  // Example texts dropdown
  exampleToggle?.addEventListener('click', () => {
    const isOpen = exampleMenu?.classList.toggle('hidden') === false;
    exampleToggle.setAttribute('aria-expanded', String(isOpen));
    exampleChevron?.classList.toggle('rotate-180', isOpen);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!exampleToggle?.contains(e.target as Node) && !exampleMenu?.contains(e.target as Node)) {
      exampleMenu?.classList.add('hidden');
      exampleToggle?.setAttribute('aria-expanded', 'false');
      exampleChevron?.classList.remove('rotate-180');
    }
  });

  // Load example text
  exampleButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const level = (btn as HTMLElement).dataset.level;
      if (level && exampleTexts[level] && textInput) {
        textInput.value = exampleTexts[level];
        exampleMenu?.classList.add('hidden');
        exampleToggle?.setAttribute('aria-expanded', 'false');
        exampleChevron?.classList.remove('rotate-180');
        updateAnalysis();
      }
    });
  });

  // URL parameter support
  function loadFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const text = params.get('text');
    if (text && textInput) {
      textInput.value = decodeURIComponent(text);
      updateAnalysis();
    }
  }

  // Initial load
  loadFromUrl();

  // If no URL param and there's text, analyze it
  if (!window.location.search && textInput?.value.trim()) {
    updateAnalysis();
  }
</script>
